var $=Object.defineProperty;var h=(o,e)=>{for(var t in e)$(o,t,{get:e[t],enumerable:!0})};var E;(function(o){o.GET="GET",o.PUT="PUT",o.POST="POST",o.PATCH="PATCH",o.DELETE="DELETE"})(E||(E={}));var I;(function(o){o.Vercel="Vercel",o.Local="Local"})(I||(I={}));var s;(function(o){o.JSON="JSON",o.Text="Text",o.None="None"})(s||(s={}));var w={[s.JSON]:"application/json",[s.Text]:"text/plain",[s.None]:void 0};var C={100:"Continue",101:"Switching Protocols",102:"Processing",103:"Early Hints",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",208:"Already Reported",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Payload Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"I'm a Teapot \u{1FAD6}",421:"Misdirected Request",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Too Early",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",510:"Not Extended",511:"Network Authentication Required"};var V={headers:{},status:200},c=class o{static new(e){let t=o.defaultOptions(s.None,e);return{status:t.status,statusText:o.getStatusText(t.status),headers:t.headers,body:void 0,bodyType:s.None}}static text(e,t){let r=o.defaultOptions(s.Text,t);return{status:r.status,statusText:o.getStatusText(r.status),headers:r.headers,body:e,bodyType:s.Text}}static JSON(e,t){let r=o.defaultOptions(s.JSON,t);return{status:r.status,statusText:o.getStatusText(r.status),headers:r.headers,body:e,bodyType:s.JSON}}static redirect(e,t){let r=o.defaultOptions(s.None,t);return{status:302,statusText:o.getStatusText(302),headers:{Location:e,...r.headers},body:void 0,bodyType:s.None}}static defaultOptions(e,t){let r={...V,...t};return r.headers={"Content-Type":w[e],...r.headers},r}static getStatusText(e){let t=C[e];if(!t)throw new Error(`Status code "${e}" is invalid.`);return t}};var A=require("http");var u=class{static getPathname(e){let t=this.getInstance(e).pathname;return t=t.replace(/\/\.\//g,"/"),t=t.replace(/\/[^/]+\/\.\.\//g,"/"),t}static getSearchParams(e){return this.getInstance(e).searchParams}static getInstance(e){return e=e.endsWith("/")?e.slice(0,-1):e,new URL(`https://example.com${e}`)}};var f=class{port;server;endpoints;constructor(e){this.endpoints=[],this.port=e,this.server=null}start(){if(this.server)throw new Error("Server is already running");this.server=(0,A.createServer)(this.handleRequest.bind(this)),this.server.listen(this.port,()=>{console.log(`SherpaJS Server is listening on port "${this.port}".`)})}stop(){if(!this.server)throw new Error("Server is not running");this.server.close(()=>{console.log("Server has stopped")}),this.server=null}addRoute(e,t){this.endpoints.push({url:this.convertDynamicSegments(e),handler:t})}convertDynamicSegments(e){return new RegExp("^/"+e.replace(/\[([^/]+?)\]/g,(t,r)=>`(?<${r}>[^/]+)`)+"(/)?$")}async handleRequest(e,t){let r=e.url;if(!r){t.writeHead(400),t.end();return}let a=this.getEndpoint(r);if(!a){t.writeHead(404),t.end();return}await a.handler(e,t)}getEndpoint(e){let t=u.getPathname(e);for(let r of this.endpoints)if(r.url.test(t))return r}};var T="SHERPA-PARAMS",l=class{static pathParamAsQueryParamRedirect(e){let t=[],r=[];for(let n=0;n<e.length;n++)e[n].isDynamic?(t.push(`(?<key-${n}>[a-zA-Z0-9,-_]+)`),r.push(`$key-${n}`)):t.push(e[n].name);let a=`/${t.join("/")}`,d=`/${this.getDynamicURL(e)}?${T}=${r.join(",")}`;return{source:a,destination:d}}static pathParamAsQueryParamRedirectProcess(e,t){let r=u.getSearchParams(e);if(!r.has(T))return e;let a=r.get(T),d=0;return r.delete(T),`/${t.map(n=>n.isDynamic?(d+=1,a[d-1]):n.name).join("/")}${r.size>0?`?${r.toString()}`:""}`}static getDynamicURL(e){return e.map(t=>t.isDynamic?`[${t.name}]`:t.name).join("/")}static parseHeader(e){let t={};return Object.keys(e).forEach(r=>{t[r]=e[r]}),t}static parseParamsPath(e,t){let r={};return u.getPathname(e).split("/").filter(a=>a!="").forEach((a,d)=>{if(t[d].isDynamic){let n=t[d].name,J=this.parseParam(a);this.setValue(r,n,J)}}),r}static parseParamsQuery(e){let t={};return u.getSearchParams(e).forEach((r,a)=>{this.setValue(t,a,this.parseParam(r))}),t}static setValue(e,t,r){e.hasOwnProperty(t)?Array.isArray(e[t])?e[t].push(...r):e[t]=[e[t],...r]:e[t]=r.length==1?r[0]:r}static parseParam(e){return e.includes(",")?e.split(",").map(t=>this.parseParam(t)).flat():e=="true"?[!0]:e=="false"?[!1]:/^\d+$/.test(e)?[parseInt(e)]:[e]}};var g=class{static async Local(e,t){if(!e.url||!e.method)throw new Error("Missing URL and Methods");let{body:r,bodyType:a}=await this.parseBodyLocal(e);return{url:u.getPathname(e.url),params:{path:l.parseParamsPath(e.url,t),query:l.parseParamsQuery(e.url)},method:e.method.toUpperCase(),headers:l.parseHeader(e.headers),body:r,bodyType:a}}static parseBodyLocal(e){return new Promise((t,r)=>{let a="",d=s.Text;e.on("data",n=>{a+=n.toString()}),e.on("end",()=>{let n=e.headers["content-type"];(!n||a=="")&&t({body:void 0,bodyType:s.None}),n=="application/json"&&(a=JSON.parse(a),d=s.JSON),t({body:a,bodyType:d})}),e.on("error",n=>{t({body:void 0,bodyType:s.None})})})}static async Vercel(e,t){let r=l.pathParamAsQueryParamRedirectProcess(e.url,t),{body:a,bodyType:d}=await this.parseBodyVercel(e);return{url:u.getPathname(r),params:{path:l.parseParamsPath(r,t),query:l.parseParamsQuery(r)},method:e.method.toUpperCase(),headers:l.parseHeader(e.headers),body:a,bodyType:d}}static async parseBodyVercel(e){let t=e.headers["content-type"];return t?t=="application/json"?{body:await e.json(),bodyType:s.JSON}:{body:await e.text(),bodyType:s.Text}:{body:void 0,bodyType:s.None}}};var q=Response,x=class{static Local(e,t){t.statusCode=e.status,t.statusMessage=e.statusText;for(let[r,a]of Object.entries(e.headers))a&&t.setHeader(r,a);t.end(this.getBody(e))}static Vercel(e){return new q(this.getBody(e),{headers:e.headers,status:e.status,statusText:e.statusText})}static getBody(e){switch(e.bodyType){case s.Text:return e.body;case s.JSON:return JSON.stringify(e.body)}}};async function v(o,e,t){let r=o[t.method];if(r)try{let a=await r(t,e);return a||c.new({status:200})}catch(a){return c.text(a.message,{status:500})}else return c.new({status:405})}var i={RequestTransform:g,ResponseTransform:x,LocalServer:f,Handler:v};var b={};h(b,{GET:()=>G,POST:()=>Q});var S=class{static server(e){return e}static module(e){return e}},P=class{static module(e){return e}};var M={JSON:"application/json",Text:"text/plain",None:void 0};var U={100:"Continue",101:"Switching Protocols",102:"Processing",103:"Early Hints",200:"OK",201:"Created",202:"Accepted",203:"Non-Authoritative Information",204:"No Content",205:"Reset Content",206:"Partial Content",207:"Multi-Status",208:"Already Reported",226:"IM Used",300:"Multiple Choices",301:"Moved Permanently",302:"Found",303:"See Other",304:"Not Modified",307:"Temporary Redirect",308:"Permanent Redirect",400:"Bad Request",401:"Unauthorized",402:"Payment Required",403:"Forbidden",404:"Not Found",405:"Method Not Allowed",406:"Not Acceptable",407:"Proxy Authentication Required",408:"Request Timeout",409:"Conflict",410:"Gone",411:"Length Required",412:"Precondition Failed",413:"Payload Too Large",414:"URI Too Long",415:"Unsupported Media Type",416:"Range Not Satisfiable",417:"Expectation Failed",418:"I'm a Teapot \u{1FAD6}",421:"Misdirected Request",422:"Unprocessable Entity",423:"Locked",424:"Failed Dependency",425:"Too Early",426:"Upgrade Required",428:"Precondition Required",429:"Too Many Requests",431:"Request Header Fields Too Large",451:"Unavailable For Legal Reasons",500:"Internal Server Error",501:"Not Implemented",502:"Bad Gateway",503:"Service Unavailable",504:"Gateway Timeout",505:"HTTP Version Not Supported",506:"Variant Also Negotiates",507:"Insufficient Storage",508:"Loop Detected",510:"Not Extended",511:"Network Authentication Required"};var F={headers:{},status:200},p=class o{static new(e){let t=o.defaultOptions("None",e);return{status:t.status,statusText:o.getStatusText(t.status),headers:t.headers,body:void 0,bodyType:"None"}}static text(e,t){let r=o.defaultOptions("Text",t);return{status:r.status,statusText:o.getStatusText(r.status),headers:r.headers,body:e,bodyType:"Text"}}static JSON(e,t){let r=o.defaultOptions("JSON",t);return{status:r.status,statusText:o.getStatusText(r.status),headers:r.headers,body:e,bodyType:"JSON"}}static redirect(e,t){let r=o.defaultOptions("None",t);return{status:302,statusText:o.getStatusText(302),headers:{Location:e,...r.headers},body:void 0,bodyType:"None"}}static defaultOptions(e,t){let r={...F,...t};return r.headers={"Content-Type":M[e],...r.headers},r}static getStatusText(e){let t=U[e];if(!t)throw new Error(`Status code "${e}" is invalid.`);return t}};var R={New:S,Load:P};function G(o,e){return p.JSON({context:e.test})}function Q(o,e){return p.JSON({bodyType:o.bodyType,body:o.body,query:o.params,url:o.url})}var m=R.Load.module({entry:"../../../test2",context:{test:"Hello World"}});var N={};h(N,{GET:()=>k});function k(o,e){return p.redirect("../path2")}var O={};h(O,{GET:()=>j,POST:()=>X});function j(o,e){return p.JSON({bodyType:o.bodyType,body:o.body,query:o.params,url:o.url})}function X(o,e){return p.text("foo")}var L={};h(L,{GET:()=>z});function z(o,e){return p.JSON({test:2,context:e},{status:201})}var B=R.New.server({context:"foo"});var _=process.argv[2],Y=_&&!isNaN(parseInt(_))?parseInt(_):3e3,y=new i.LocalServer(Y),W=m.context,K=[{name:"module",isDynamic:!1}],Z="module";y.addRoute(Z,async(o,e)=>{let t=await i.RequestTransform.Local(o,K),r=await i.Handler(b,W,t);i.ResponseTransform.Local(r,e)});var ee=m.context,te=[{name:"module",isDynamic:!1},{name:"id",isDynamic:!0},{name:"path1",isDynamic:!1}],re="module/[id]/path1";y.addRoute(re,async(o,e)=>{let t=await i.RequestTransform.Local(o,te),r=await i.Handler(N,ee,t);i.ResponseTransform.Local(r,e)});var oe=m.context,ae=[{name:"module",isDynamic:!1},{name:"id",isDynamic:!0},{name:"path2",isDynamic:!1}],se="module/[id]/path2";y.addRoute(se,async(o,e)=>{let t=await i.RequestTransform.Local(o,ae),r=await i.Handler(O,oe,t);i.ResponseTransform.Local(r,e)});var ne=B.context,ie=[{name:"regular",isDynamic:!1}],pe="regular";y.addRoute(pe,async(o,e)=>{let t=await i.RequestTransform.Local(o,ie),r=await i.Handler(L,ne,t);i.ResponseTransform.Local(r,e)});y.start();
// Generated by SherpaJS
